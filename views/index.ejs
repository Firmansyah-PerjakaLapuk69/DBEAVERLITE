<div class="d-flex">
  <!-- Sidebar -->
  <nav class="bg-light border-end p-3" style="width: 250px;">
    <h4 class="mb-4">PG Admin Lite</h4>

    <label class="form-label">Tables:</label>
    <select class="form-select mb-2" id="tableSelect">
      <option value="">-- Choose Table --</option>
      <% tables.forEach(table => { %>
        <option value="<%= table %>"><%= table %></option>
      <% }); %>
    </select>

    <button class="btn btn-outline-primary w-100 mb-2" onclick="loadTable()">Load Table</button>
    <button class="btn btn-secondary w-100 mb-2" onclick="copyQuery()">Copy SQL</button>
    <button class="btn btn-success w-100 mb-2" onclick="downloadCSV()">Download CSV</button>
    <button class="btn btn-outline-danger w-100" onclick="resetQuery()">Reset</button>

    <% if (history && history.length > 0) { %>
      <hr>
      <h6>Query History</h6>
      <ul class="list-group small">
        <% history.forEach(h => { %>
          <li class="list-group-item"><code><%= h %></code></li>
        <% }) %>
      </ul>
    <% } %>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow-1 p-4">
    <form action="/query" method="POST" id="queryForm">
      <div class="mb-3">
        <label class="form-label">Enter SQL Query:</label>
        <textarea class="form-control" name="sql" rows="5" id="sqlBox"><%= sql || '' %></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Run Query</button>
    </form>

    <!-- Hidden form for CSV -->
    <form action="/query/download?delimiter=semicolon" method="POST" id="downloadForm" target="_blank" style="display: none;">
      <input type="hidden" name="sql" id="downloadSQL">
    </form>

    <% if (output) { %>
      <h5 class="mt-4">Output:</h5>
      <pre class="bg-light p-3 rounded"><%= output %></pre>
    <% } %>

    <% if (pagination && pagination.totalPages > 1) { %>
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination">
          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
              <a class="page-link page-btn" href="#" data-page="<%= i %>"><%= i %></a>
            </li>
          <% } %>
        </ul>
      </nav>
    <% } %>
  </main>
</div>

<script>
  function copyQuery() {
    const textarea = document.getElementById("sqlBox");
    textarea.select();
    document.execCommand("copy");
    alert("SQL copied to clipboard!");
  }

  function loadTable() {
    const selected = document.getElementById("tableSelect").value;
    if (selected) {
      const sql = `SELECT * FROM ${selected};`;
      document.getElementById("sqlBox").value = sql;
    }
  }

  function resetQuery() {
    document.getElementById("sqlBox").value = "";
  }

  function downloadCSV() {
    const sql = document.getElementById("sqlBox").value;
    document.getElementById("downloadSQL").value = sql;
    document.getElementById("downloadForm").submit();
  }

  function goToPage(page) {
    const sql = document.getElementById("sqlBox").value;
    const form = document.createElement("form");
    form.method = "POST";
    form.action = `/query?page=${page}&limit=20`;

    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "sql";
    input.value = sql;
    form.appendChild(input);

    document.body.appendChild(form);
    form.submit();
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".page-btn").forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const page = this.dataset.page;
        goToPage(page);
      });
    });
  });
</script>
